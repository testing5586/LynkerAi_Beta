<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三方协作聊天 - Lynker Master AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-enter {
            animation: fadeInUp 0.3s ease-out;
        }
        .message-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .message-card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        .bg-gradient-dark {
            background: linear-gradient(to bottom, #0f172a, #1e293b, #0f172a);
        }
        pre {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden">
    <div class="w-full h-full flex flex-col bg-gradient-dark text-white">
        <!-- Header -->
        <div class="bg-slate-900/80 backdrop-blur-md border-b border-white/10 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        🧠 三方协作聊天
                    </h1>
                    <p class="text-sm text-slate-400 mt-1">Master AI ↔ Child AI ↔ User 实时对话</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-xs">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-slate-400">实时同步</span>
                    </div>
                    <button onclick="clearLogs()" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition">
                        清空日志
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 space-y-4">
            <div class="text-center text-slate-500 py-20">
                <div class="animate-pulse">加载对话记录...</div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-white/10 bg-slate-900/80 backdrop-blur-md">
            <div class="max-w-4xl mx-auto flex items-center gap-3">
                <input
                    id="messageInput"
                    type="text"
                    placeholder="输入消息给 Master AI..."
                    class="flex-1 bg-slate-800 text-white rounded-xl px-4 py-3 outline-none border border-white/10 focus:border-purple-400 transition"
                    onkeypress="handleKeyPress(event)"
                />
                <button
                    id="sendButton"
                    onclick="sendMessage()"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-xl transition disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                >
                    发送
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'lynker_relay_secret_2025';
        let logs = [];
        let isSending = false;

        const roleConfig = {
            master: { label: 'Master AI', icon: '🧠', color: 'bg-purple-500' },
            child: { label: 'Child AI', icon: '🤖', color: 'bg-emerald-500' },
            user: { label: 'You', icon: '👤', color: 'bg-blue-500' },
            system: { label: 'System', icon: '⚙️', color: 'bg-gray-500' }
        };

        function getRole(log) {
            if (log.from === 'master') return roleConfig.master;
            if (log.from === 'child' || log.child_id) return roleConfig.child;
            if (log.from === 'user') return roleConfig.user;
            return roleConfig.system;
        }

        function formatTime(ts) {
            return ts ? ts.split(' ')[1] : '';
        }

        function formatContent(log) {
            if (log.text) return log.text;
            if (log.result) return JSON.stringify(log.result, null, 2);
            if (log.event === 'callback') {
                return `✅ 任务完成\nTask ID: ${log.task_id}\n状态: ${log.status}\n结果: ${JSON.stringify(log.result, null, 2)}`;
            }
            if (log.event === 'ack') {
                return `👌 消息确认\nTask ID: ${log.task_id}\n确认方: ${log.ack_by}`;
            }
            return JSON.stringify(log, null, 2);
        }

        function renderMessage(log, index) {
            const role = getRole(log);
            const align = log.from === 'user' ? 'items-end text-right' : 'items-start';
            const content = formatContent(log);
            const time = formatTime(log.ts);

            return `
                <div class="flex flex-col ${align} group message-enter">
                    <div class="flex items-center gap-2 opacity-80 text-xs mb-1">
                        <div class="rounded-full px-3 py-1 ${role.color} text-white text-xs flex items-center gap-1.5">
                            <span>${role.icon}</span>
                            <span>${role.label}</span>
                        </div>
                        <span class="text-slate-400">${time}</span>
                    </div>
                    <div class="message-card max-w-[80%] rounded-2xl px-4 py-3 text-sm leading-relaxed backdrop-blur-md bg-white/10 border border-white/10">
                        <pre class="text-white/90">${content}</pre>
                    </div>
                </div>
            `;
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-20">暂无对话记录</div>';
                return;
            }
            container.innerHTML = logs.map((log, i) => renderMessage(log, i)).join('');
            container.scrollTop = container.scrollHeight;
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/api/relay/logs?limit=100');
                const data = await res.json();
                logs = data.logs || [];
                renderMessages();
            } catch (error) {
                console.error('获取日志失败:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            const text = input.value.trim();

            if (!text || isSending) return;

            isSending = true;
            button.disabled = true;
            button.textContent = '发送中...';

            try {
                const res = await fetch('/api/relay/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Relay-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        from: 'user',
                        to: 'master',
                        type: 'message',
                        text: text
                    })
                });

                if (res.ok) {
                    input.value = '';
                    setTimeout(fetchLogs, 500);
                } else {
                    alert('发送失败，请重试');
                }
            } catch (error) {
                console.error('发送消息失败:', error);
                alert('发送失败，请检查网络连接');
            } finally {
                isSending = false;
                button.disabled = false;
                button.textContent = '发送';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function clearLogs() {
            if (confirm('确定要清空所有日志吗？此操作不可恢复。')) {
                logs = [];
                renderMessages();
            }
        }

        fetchLogs();
        setInterval(fetchLogs, 2500);
    </script>
</body>
</html>
