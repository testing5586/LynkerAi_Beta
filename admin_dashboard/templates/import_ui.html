<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>命盘批量导入中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0b1220;color:#e6edf3;font-family:system-ui, -apple-system;}
    .wrap{max-width:900px;margin:40px auto;padding:24px}
    .card{background:#111a2b;border:1px solid #1f2a44;border-radius:16px;padding:20px;margin-bottom:20px}
    h1{text-align:center;margin:0 0 30px 0;color:#40e0a8}
    h2{margin:0 0 12px 0}
    input,button{padding:10px 14px;border-radius:10px;border:1px solid #2a3758;background:#0b1220;color:#e6edf3;font-size:14px}
    button{cursor:pointer;background:#1a4d7a;transition:all 0.2s}
    button:hover{background:#2a5d8a}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .ok{color:#40e0a8}
    .err{color:#ff6b6b}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    textarea{width:100%;height:180px;background:#0b1220;border:1px solid #2a3758;color:#e6edf3;border-radius:10px;padding:10px;font-family:monospace;font-size:13px}
    label{opacity:.85;display:block;margin-bottom:6px;font-weight:500}
    .info{background:#1a2847;padding:12px;border-radius:8px;margin-top:12px;font-size:13px;line-height:1.6}
  </style>
</head>
<body>
<div class="wrap">
  <h1>🔮 命盘批量导入中心</h1>
  
  <div class="card">
    <h2>📋 文墨天机 JSON 导入</h2>
    <div class="row">
      <input type="file" id="jsonfile" accept=".json" />
      <button onclick="uploadJSON()">上传并导入</button>
      <span id="jsonStatus"></span>
    </div>
    <div class="info">
      💡 支持文墨天机软件导出的 JSON 格式，自动解析姓名、性别、出生时间、夫妻宫、财帛宫、飞化信息
    </div>
  </div>

  <div class="card">
    <h2>📄 文档导入（TXT / DOCX）</h2>
    <div class="row">
      <input type="file" id="docfile" accept=".txt,.docx" />
      <button onclick="filePreview()">识别并预览</button>
      <span id="fileStatus"></span>
    </div>
    <div class="grid" style="margin-top:16px">
      <div>
        <label>识别结果（可编辑后提交）</label>
        <textarea id="fileJson" placeholder='{"name":"命主","gender":"女","birth_time":"1990-05-20T15:30:00","marriage_palace_star":"天府","wealth_palace_star":"武曲","transformations":{"hualu":true,"huaji":false}}'></textarea>
        <div style="margin-top:10px">
          <button onclick="fileConfirm()">确认写入数据库</button>
        </div>
      </div>
      <div>
        <label>原始文本</label>
        <textarea id="fileRawText" readonly></textarea>
      </div>
    </div>
    <div class="info">
      💡 <strong style="color:#40e0a8">傻瓜式导入</strong> - 支持 .txt 和 .docx 格式，自动提取关键字段<br>
      📝 <strong>必填字段：</strong>姓名 | <strong style="color:#888">可选字段：</strong>性别、出生时间、夫妻宫、财帛宫、化禄、化忌<br>
      ✅ <strong>即使只有姓名也能导入！</strong>其他字段会自动填充默认值，后续可补充<br>
      📖 文本格式示例：<code style="background:#0b1220;padding:2px 6px;border-radius:4px">姓名: 张三</code> 或完整版 <code style="background:#0b1220;padding:2px 6px;border-radius:4px">姓名: 张三 | 性别: 男 | 出生时间: 1990-05-20 14:30</code><br>
      ⚠️ DOCX 功能需要安装：<code style="background:#0b1220;padding:2px 6px;border-radius:4px">pip install python-docx</code>
    </div>
  </div>

  <div class="card">
    <h2>🖼️ 截图 OCR 半自动导入</h2>
    <div class="row">
      <input type="file" id="imgfile" accept="image/*,.pdf" />
      <button onclick="ocrPreview()">识别并预览</button>
      <span id="ocrStatus"></span>
    </div>
    <div class="grid" style="margin-top:16px">
      <div>
        <label>识别结果（可编辑后提交）</label>
        <textarea id="ocrJson" placeholder='{"name":"命主","gender":"女","birth_time":"1990-05-20T15:30:00","marriage_palace_star":"天府","wealth_palace_star":"武曲","transformations":{"hualu":true,"huaji":false}}'></textarea>
        <div style="margin-top:10px">
          <button onclick="ocrConfirm()">确认写入数据库</button>
        </div>
      </div>
      <div>
        <label>原始识别文本</label>
        <textarea id="rawText" readonly></textarea>
      </div>
    </div>
    <div class="info">
      ⚠️ OCR 功能需要安装依赖：<code style="background:#0b1220;padding:2px 6px;border-radius:4px">pip install pillow easyocr</code><br>
      首次使用会下载 100MB+ 模型文件，请耐心等待
    </div>
  </div>

  <div class="card" style="background:#1a2847">
    <h2>📊 导入统计</h2>
    <p id="stats">加载中...</p>
  </div>
</div>

<script>
// 页面加载时获取统计
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const r = await fetch('/import/stats');
    if (r.ok) {
      const data = await r.json();
      document.getElementById('stats').innerHTML = `
        当前数据库共有 <strong style="color:#40e0a8">${data.total || 0}</strong> 条命盘记录
      `;
    }
  } catch(e) {
    document.getElementById('stats').textContent = '统计数据加载失败';
  }
});

async function uploadJSON(){
  const file = document.getElementById('jsonfile').files[0];
  if(!file) return alert('请选择一个 JSON 文件');
  
  document.getElementById('jsonStatus').textContent = '⏳ 上传中...';
  
  const fd = new FormData();
  fd.append('file', file);
  
  try {
    const r = await fetch('/import/json', { method:'POST', body:fd });
    const j = await r.json();
    document.getElementById('jsonStatus').textContent = j.ok ? '✅ 导入成功' : ('❌ ' + j.error);
    document.getElementById('jsonStatus').className = j.ok ? 'ok' : 'err';
  } catch(e) {
    document.getElementById('jsonStatus').textContent = '❌ 网络错误';
    document.getElementById('jsonStatus').className = 'err';
  }
}

async function filePreview(){
  const file = document.getElementById('docfile').files[0];
  if(!file) return alert('请选择一个 TXT 或 DOCX 文件');
  
  document.getElementById('fileStatus').textContent = '⏳ 识别中...';
  
  const fd = new FormData();
  fd.append('file', file);
  
  try {
    const r = await fetch('/import/file/preview', { method:'POST', body: fd });
    const j = await r.json();
    
    if(!j.ok){ 
      document.getElementById('fileStatus').textContent = '❌ ' + j.error; 
      document.getElementById('fileStatus').className = 'err';
      return; 
    }
    
    const p = j.parsed || {};
    document.getElementById('fileJson').value = JSON.stringify({
      name: p.name || "",
      gender: p.gender || "",
      birth_time: p.birth_time || "",
      marriage_palace_star: p.marriage_palace_star || "",
      wealth_palace_star: p.wealth_palace_star || "",
      transformations: p.transformations || {hualu:false, huaji:false},
      file_type: j.file_type || "txt"
    }, null, 2);
    
    document.getElementById('fileRawText').value = p.raw_text || '';
    document.getElementById('fileStatus').textContent = '✅ 识别完成，请检查字段后点击"确认写入"';
    document.getElementById('fileStatus').className = 'ok';
  } catch(e) {
    document.getElementById('fileStatus').textContent = '❌ 网络错误';
    document.getElementById('fileStatus').className = 'err';
  }
}

async function fileConfirm(){
  try{
    const payload = JSON.parse(document.getElementById('fileJson').value);
    
    document.getElementById('fileStatus').textContent = '⏳ 写入中...';
    
    const r = await fetch('/import/file/confirm', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(payload)
    });
    
    const j = await r.json();
    document.getElementById('fileStatus').textContent = j.ok ? '✅ 写入成功' : ('❌ ' + j.error);
    document.getElementById('fileStatus').className = j.ok ? 'ok' : 'err';
    
    if(j.ok) {
      // 清空表单
      document.getElementById('fileJson').value = '';
      document.getElementById('fileRawText').value = '';
    }
  }catch(e){
    alert('JSON 格式不正确：' + e.message);
  }
}

async function ocrPreview(){
  const file = document.getElementById('imgfile').files[0];
  if(!file) return alert('请选择一张图片或PDF');
  
  document.getElementById('ocrStatus').textContent = '⏳ 识别中...';
  
  const fd = new FormData();
  fd.append('image', file);
  
  try {
    const r = await fetch('/import/ocr/preview', { method:'POST', body: fd });
    const j = await r.json();
    
    if(!j.ok){ 
      document.getElementById('ocrStatus').textContent = '❌ ' + j.error; 
      document.getElementById('ocrStatus').className = 'err';
      return; 
    }
    
    const p = j.parsed || {};
    document.getElementById('ocrJson').value = JSON.stringify({
      name: p.name || "",
      gender: p.gender || "",
      birth_time: p.birth_time || "",
      marriage_palace_star: p.marriage_palace_star || "",
      wealth_palace_star: p.wealth_palace_star || "",
      transformations: p.transformations || {hualu:false, huaji:false}
    }, null, 2);
    
    document.getElementById('rawText').value = p.raw_text || '';
    document.getElementById('ocrStatus').textContent = '✅ 识别完成，请检查字段后点击"确认写入"';
    document.getElementById('ocrStatus').className = 'ok';
  } catch(e) {
    document.getElementById('ocrStatus').textContent = '❌ 网络错误';
    document.getElementById('ocrStatus').className = 'err';
  }
}

async function ocrConfirm(){
  try{
    const payload = JSON.parse(document.getElementById('ocrJson').value);
    
    document.getElementById('ocrStatus').textContent = '⏳ 写入中...';
    
    const r = await fetch('/import/ocr/confirm', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(payload)
    });
    
    const j = await r.json();
    document.getElementById('ocrStatus').textContent = j.ok ? '✅ 写入成功' : ('❌ ' + j.error);
    document.getElementById('ocrStatus').className = j.ok ? 'ok' : 'err';
    
    if(j.ok) {
      // 清空表单
      document.getElementById('ocrJson').value = '';
      document.getElementById('rawText').value = '';
    }
  }catch(e){
    alert('JSON 格式不正确：' + e.message);
  }
}
</script>
</body>
</html>
